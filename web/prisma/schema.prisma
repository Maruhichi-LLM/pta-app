generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Group {
  id                   Int          @id @default(autoincrement())
  name                 String
  fiscalYearStartMonth Int
  createdAt            DateTime     @default(now())
  members              Member[]
  chatThreads          ChatThread[]
  chatMessages         ChatMessage[]
  todoItems            TodoItem[]
  inviteCodes          InviteCode[]
  ledgers              Ledger[]
  events               Event[]
  accountingSetting    AccountingSetting?
  accounts             Account[]
  financialAccounts    FinancialAccount[]
  budgets              Budget[]
  enabledModules       String[]     @default([])
  documents            Document[]
  eventBudgets         EventBudget[]
  fiscalYearCloses     FiscalYearClose[]
  audits               Audit[]
  auditLogs            AuditLog[]
  approvalTemplates    ApprovalTemplate[]
  approvalRoutes       ApprovalRoute[]
  approvalApplications ApprovalApplication[]
}

model Member {
  id                      Int                  @id @default(autoincrement())
  groupId                 Int
  group                   Group                @relation(fields: [groupId], references: [id])
  displayName             String
  role                    String
  email                   String?              @unique
  passwordHash            String?
  createdAt               DateTime             @default(now())
  usedInviteCodes         InviteCode[]         @relation("InviteCodeUsedBy")
  ledgerEntries           Ledger[]             @relation("LedgerCreatedBy")
  approvals               Approval[]           @relation("ApprovalActor")
  attendances             Attendance[]
  personalEvents          PersonalEvent[]
  documents               Document[]
  documentVersions        DocumentVersion[]
  chatMessages            ChatMessage[]
  todoItemsCreated        TodoItem[]           @relation("TodoCreatedBy")
  todoItemsAssigned       TodoItem[]           @relation("TodoAssignedTo")
  eventBudgetsConfirmed   EventBudget[]        @relation("EventBudgetConfirmedBy")
  eventTransactionsCreated EventTransaction[]  @relation("EventTransactionCreatedBy")
  eventBudgetImports      EventBudgetImport[]  @relation("EventBudgetImportedBy")
  fiscalYearClosesConfirmed FiscalYearClose[]  @relation("FiscalYearCloseConfirmedBy")
  auditsConducted         Audit[]              @relation("AuditAuditor")
  auditLogs               AuditLog[]
  approvalApplications    ApprovalApplication[] @relation("ApplicationApplicant")
  approvalAssignments     ApprovalAssignment[]
}

model InviteCode {
  id             Int       @id @default(autoincrement())
  groupId        Int
  group          Group     @relation(fields: [groupId], references: [id])
  code           String    @unique
  role           String
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  usedAt         DateTime?
  usedByMemberId Int?
  usedByMember   Member?   @relation("InviteCodeUsedBy", fields: [usedByMemberId], references: [id])
}

model Ledger {
  id                  Int           @id @default(autoincrement())
  groupId             Int
  group               Group         @relation(fields: [groupId], references: [id])
  createdByMemberId   Int
  createdBy           Member        @relation("LedgerCreatedBy", fields: [createdByMemberId], references: [id])
  title               String
  amount              Int
  transactionDate     DateTime      @default(now())
  receiptUrl          String?
  notes               String?
  status              LedgerStatus  @default(PENDING)
  approvals           Approval[]
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  sourceChatMessageId Int?          @unique
  sourceThreadId      Int?
  sourceChatMessage   ChatMessage?  @relation("LedgerSourceChat", fields: [sourceChatMessageId], references: [id])
  sourceThread        ChatThread?   @relation("LedgerThread", fields: [sourceThreadId], references: [id])
  accountId           Int?
  account             Account?      @relation("AccountLedgers", fields: [accountId], references: [id])
  eventBudgetId       Int?
  eventBudget         EventBudget?  @relation("LedgerEventBudget", fields: [eventBudgetId], references: [id])

  @@index([sourceThreadId])
  @@index([eventBudgetId])
}

model Approval {
  id               Int            @id @default(autoincrement())
  ledgerId         Int
  ledger           Ledger         @relation(fields: [ledgerId], references: [id])
  actedByMemberId  Int
  actedBy          Member         @relation("ApprovalActor", fields: [actedByMemberId], references: [id])
  action           ApprovalAction
  comment          String?
  createdAt        DateTime       @default(now())
}

model Event {
  id          Int           @id @default(autoincrement())
  groupId     Int
  group       Group         @relation(fields: [groupId], references: [id])
  title       String
  description String?
  location    String?
  startsAt    DateTime
  endsAt      DateTime?
  attendances Attendance[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  documents   Document[]
  budget      EventBudget?
}

model Attendance {
  id          Int              @id @default(autoincrement())
  eventId     Int
  event       Event            @relation(fields: [eventId], references: [id])
  memberId    Int
  member      Member           @relation(fields: [memberId], references: [id])
  status      AttendanceStatus @default(MAYBE)
  comment     String?
  respondedAt DateTime         @default(now())
  createdAt   DateTime         @default(now())

  @@unique([eventId, memberId])
}

enum LedgerStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum ApprovalAction {
  APPROVED
  REJECTED
}

enum AttendanceStatus {
  YES
  NO
  MAYBE
}

enum AuditType {
  FINANCIAL
  ACTIVITY
}

enum AuditStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
}

enum AuditFindingCategory {
  ISSUE
  SUGGESTION
  OBSERVATION
}

enum AuditFindingSeverity {
  HIGH
  MEDIUM
  LOW
}

enum AuditFindingStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

model Audit {
  id          Int          @id @default(autoincrement())
  groupId     Int
  group       Group        @relation(fields: [groupId], references: [id])
  auditorId   Int
  auditor     Member       @relation("AuditAuditor", fields: [auditorId], references: [id])
  type        AuditType
  fiscalYear  Int
  startDate   DateTime
  endDate     DateTime
  status      AuditStatus  @default(PLANNED)
  report      String?
  findings    AuditFinding[]
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([groupId])
  @@index([auditorId])
}

model AuditFinding {
  id                Int                 @id @default(autoincrement())
  auditId           Int
  audit             Audit               @relation(fields: [auditId], references: [id])
  category          AuditFindingCategory
  severity          AuditFindingSeverity
  description       String
  relatedRecordType String?
  relatedRecordId   Int?
  recommendation    String?
  status            AuditFindingStatus  @default(OPEN)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([auditId])
}

model AuditLog {
  id           Int      @id @default(autoincrement())
  groupId      Int
  group        Group    @relation(fields: [groupId], references: [id])
  memberId     Int?
  member       Member?  @relation(fields: [memberId], references: [id])
  action       String
  targetType   String
  targetId     Int?
  previousValue Json?
  newValue     Json?
  ipAddress    String?
  createdAt    DateTime @default(now())

  @@index([groupId])
  @@index([memberId])
}
model PersonalEvent {
  id          Int      @id @default(autoincrement())
  memberId    Int
  member      Member   @relation(fields: [memberId], references: [id])
  title       String
  description String?
  location    String?
  startsAt    DateTime
  endsAt      DateTime?
  color       String   @default("sky")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AccountingSetting {
  id                   Int      @id @default(autoincrement())
  groupId              Int      @unique
  group                Group    @relation(fields: [groupId], references: [id])
  fiscalYearStartMonth Int
  fiscalYearEndMonth   Int
  approvalFlow         String?
  carryoverAmount      Int      @default(0)
  budgetEnabled        Boolean  @default(true)
  accountingEnabled    Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model Document {
  id                  Int              @id @default(autoincrement())
  groupId             Int
  group               Group            @relation(fields: [groupId], references: [id])
  title               String
  category            DocumentCategory
  fiscalYear          Int
  eventId             Int?
  event               Event?           @relation(fields: [eventId], references: [id])
  createdByMemberId   Int
  createdBy           Member           @relation(fields: [createdByMemberId], references: [id])
  versions            DocumentVersion[]
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  sourceChatMessageId Int?             @unique
  sourceThreadId      Int?
  sourceChatMessage   ChatMessage?     @relation("DocumentSourceChat", fields: [sourceChatMessageId], references: [id])
  sourceThread        ChatThread?      @relation("DocumentThread", fields: [sourceThreadId], references: [id])

  @@index([sourceThreadId])
}

model DocumentVersion {
  id                Int      @id @default(autoincrement())
  documentId        Int
  document          Document @relation(fields: [documentId], references: [id])
  versionNumber     Int
  originalFilename  String
  storedPath        String
  mimeType          String
  sizeBytes         Int
  createdByMemberId Int
  createdBy         Member   @relation(fields: [createdByMemberId], references: [id])
  createdAt         DateTime @default(now())
}

enum DocumentCategory {
  POLICY
  REPORT
  FINANCE
  MEETING_NOTE
  OTHER
}

enum ThreadSourceType {
  TODO
  EVENT
  ACCOUNTING
  DOCUMENT
  FREE
}

enum ThreadStatus {
  OPEN
  CLOSED
}

model ChatThread {
  id           Int           @id @default(autoincrement())
  groupId      Int
  group        Group         @relation(fields: [groupId], references: [id])
  title        String
  sourceType   ThreadSourceType
  sourceId     Int?
  status       ThreadStatus  @default(OPEN)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  messages     ChatMessage[]
  todoItems    TodoItem[]
  ledgerEntries Ledger[]     @relation("LedgerThread")
  documents    Document[]    @relation("DocumentThread")

  @@index([groupId, status])
  @@index([groupId, sourceType, sourceId])
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  threadId  Int
  thread    ChatThread @relation(fields: [threadId], references: [id])
  groupId   Int
  group     Group    @relation(fields: [groupId], references: [id])
  authorId  Int
  author    Member   @relation(fields: [authorId], references: [id])
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  todoItems TodoItem[]
  ledgerEntries Ledger[] @relation("LedgerSourceChat")
  documents Document[]   @relation("DocumentSourceChat")

  @@index([threadId, createdAt])
  @@index([authorId, createdAt])
}

model TodoItem {
  id                   Int        @id @default(autoincrement())
  groupId              Int
  group                Group      @relation(fields: [groupId], references: [id])
  createdByMemberId    Int
  createdBy            Member     @relation("TodoCreatedBy", fields: [createdByMemberId], references: [id])
  assignedMemberId     Int?
  assignedTo           Member?    @relation("TodoAssignedTo", fields: [assignedMemberId], references: [id])
  title                String
  body                 String?
  status               TodoStatus @default(TODO)
  dueDate              DateTime?
  sourceThreadId       Int?
  sourceChatMessageId  Int?       @unique
  sourceChatMessage    ChatMessage? @relation(fields: [sourceChatMessageId], references: [id])
  sourceThread         ChatThread? @relation(fields: [sourceThreadId], references: [id])
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  @@index([sourceThreadId])
  @@index([sourceChatMessageId])
}

enum TodoStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum EventBudgetStatus {
  PLANNING
  IN_PROGRESS
  CONFIRMED
  IMPORTED
}

enum EventTransactionType {
  REVENUE
  EXPENSE
}

model Account {
  id                 Int                  @id @default(autoincrement())
  groupId            Int
  group              Group                @relation(fields: [groupId], references: [id])
  name               String
  type               AccountType
  isCustom           Boolean              @default(false)
  isArchived         Boolean              @default(false)
  order              Int                  @default(0)
  createdAt          DateTime             @default(now())
  budgets            Budget[]
  ledgers            Ledger[]             @relation("AccountLedgers")
  eventTransactions  EventTransaction[]   @relation("EventTransactionAccount")
}

model FinancialAccount {
  id             Int                  @id @default(autoincrement())
  groupId        Int
  group          Group                @relation(fields: [groupId], references: [id])
  name           String
  type           FinancialAccountType
  bankName       String?
  accountNumber  String?
  initialBalance Int                  @default(0)
  currentBalance Int                  @default(0)
  createdAt      DateTime             @default(now())
}

enum AccountType {
  ASSET
  LIABILITY
  INCOME
  EXPENSE
}

enum FinancialAccountType {
  CASH
  BANK
}

model Budget {
  id         Int      @id @default(autoincrement())
  groupId    Int
  group      Group    @relation(fields: [groupId], references: [id])
  accountId  Int
  account    Account  @relation(fields: [accountId], references: [id])
  fiscalYear Int
  amount     Int
  createdAt  DateTime @default(now())

  @@unique([groupId, accountId, fiscalYear])
}

model EventBudget {
  id                 Int                  @id @default(autoincrement())
  eventId            Int                  @unique
  event              Event                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  groupId            Int
  group              Group                @relation(fields: [groupId], references: [id], onDelete: Cascade)
  plannedRevenue     Int                  @default(0)
  plannedExpense     Int                  @default(0)
  actualRevenue      Int                  @default(0)
  actualExpense      Int                  @default(0)
  status             EventBudgetStatus    @default(PLANNING)
  confirmedAt        DateTime?
  confirmedById      Int?
  confirmedBy        Member?              @relation("EventBudgetConfirmedBy", fields: [confirmedById], references: [id])
  importedToLedgerAt DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  transactions       EventTransaction[]
  imports            EventBudgetImport[]
  ledgerEntries      Ledger[]             @relation("LedgerEventBudget")

  @@index([groupId])
  @@index([eventId])
}

model EventTransaction {
  id                Int                  @id @default(autoincrement())
  eventBudgetId     Int
  eventBudget       EventBudget          @relation(fields: [eventBudgetId], references: [id], onDelete: Cascade)
  type              EventTransactionType
  accountId         Int?
  account           Account?             @relation("EventTransactionAccount", fields: [accountId], references: [id])
  amount            Int
  description       String
  transactionDate   DateTime
  receiptUrl        String?
  notes             String?
  createdByMemberId Int
  createdBy         Member               @relation("EventTransactionCreatedBy", fields: [createdByMemberId], references: [id])
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([eventBudgetId])
  @@index([accountId])
}

model EventBudgetImport {
  id                 Int         @id @default(autoincrement())
  eventBudgetId      Int
  eventBudget        EventBudget @relation(fields: [eventBudgetId], references: [id], onDelete: Cascade)
  importedByMemberId Int
  importedBy         Member      @relation("EventBudgetImportedBy", fields: [importedByMemberId], references: [id])
  importedAt         DateTime    @default(now())
  ledgerEntryCount   Int
  notes              String?

  @@index([eventBudgetId])
}

enum FiscalYearCloseStatus {
  DRAFT
  CONFIRMED
}

model FiscalYearClose {
  id                 Int                    @id @default(autoincrement())
  groupId            Int
  group              Group                  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  fiscalYear         Int
  startDate          DateTime
  endDate            DateTime
  status             FiscalYearCloseStatus  @default(DRAFT)
  totalRevenue       Int                    @default(0)
  totalExpense       Int                    @default(0)
  balance            Int                    @default(0)
  previousCarryover  Int                    @default(0)
  nextCarryover      Int                    @default(0)
  statement          Json?
  confirmedAt        DateTime?
  confirmedById      Int?
  confirmedBy        Member?                @relation("FiscalYearCloseConfirmedBy", fields: [confirmedById], references: [id])
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  @@unique([groupId, fiscalYear])
  @@index([groupId, status])
}

enum ApprovalStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum ApprovalStepStatus {
  WAITING
  IN_PROGRESS
  APPROVED
  REJECTED
}

model ApprovalRoute {
  id        Int      @id @default(autoincrement())
  groupId   Int
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  steps     ApprovalStep[]
  templates ApprovalTemplate[]
}

model ApprovalStep {
  id           Int      @id @default(autoincrement())
  routeId      Int
  route        ApprovalRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)
  stepOrder    Int
  approverRole String
  requireAll   Boolean @default(true)
  conditions   Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ApprovalTemplate {
  id          Int      @id @default(autoincrement())
  groupId     Int
  group       Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  name        String
  description String?
  fields      Json
  routeId     Int
  route       ApprovalRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  applications ApprovalApplication[]
}

model ApprovalApplication {
  id           Int            @id @default(autoincrement())
  groupId      Int
  group        Group          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  templateId   Int
  template     ApprovalTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  applicantId  Int
  applicant    Member         @relation("ApplicationApplicant", fields: [applicantId], references: [id])
  title        String
  data         Json
  status       ApprovalStatus @default(DRAFT)
  currentStep  Int?           @default(1)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  assignments  ApprovalAssignment[]
}

model ApprovalAssignment {
  id            Int                @id @default(autoincrement())
  applicationId Int
  application   ApprovalApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  stepId        Int
  stepOrder     Int
  approverRole  String
  assignedToId  Int?
  assignedTo    Member?           @relation(fields: [assignedToId], references: [id])
  status        ApprovalStepStatus @default(WAITING)
  actedAt       DateTime?
  comment       String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([applicationId, stepOrder])
}
