generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Group {
  id                   Int          @id @default(autoincrement())
  name                 String
  fiscalYearStartMonth Int
  createdAt            DateTime     @default(now())
  members              Member[]
  chatThreads          ChatThread[]
  chatMessages         ChatMessage[]
  todoItems            TodoItem[]
  inviteCodes          InviteCode[]
  ledgers              Ledger[]
  events               Event[]
  accountingSetting    AccountingSetting?
  accounts             Account[]
  financialAccounts    FinancialAccount[]
  budgets              Budget[]
  enabledModules       String[]     @default([])
  documents            Document[]
  records              Record[]
  eventBudgets         EventBudget[]
  fiscalYearCloses     FiscalYearClose[]
  auditLogs            AuditLog[]
  internalControlRules InternalControlRule[]
  auditFindings        AuditFinding[]
  approvalTemplates    ApprovalTemplate[]
  approvalRoutes       ApprovalRoute[]
  approvalApplications ApprovalApplication[]
  votings              Voting[]
  searchIndexes        SearchIndex[]
}

model Member {
  id                      Int                  @id @default(autoincrement())
  groupId                 Int
  group                   Group                @relation(fields: [groupId], references: [id])
  displayName             String
  role                    String
  email                   String?              @unique
  passwordHash            String?
  createdAt               DateTime             @default(now())
  usedInviteCodes         InviteCode[]         @relation("InviteCodeUsedBy")
  ledgerEntries           Ledger[]             @relation("LedgerCreatedBy")
  approvals               Approval[]           @relation("ApprovalActor")
  attendances             Attendance[]
  personalEvents          PersonalEvent[]
  documents               Document[]
  documentVersions        DocumentVersion[]
  chatMessages            ChatMessage[]
  todoItemsCreated        TodoItem[]           @relation("TodoCreatedBy")
  todoItemsAssigned       TodoItem[]           @relation("TodoAssignedTo")
  eventBudgetsConfirmed   EventBudget[]        @relation("EventBudgetConfirmedBy")
  eventTransactionsCreated EventTransaction[]  @relation("EventTransactionCreatedBy")
  eventBudgetImports      EventBudgetImport[]  @relation("EventBudgetImportedBy")
  fiscalYearClosesConfirmed FiscalYearClose[]  @relation("FiscalYearCloseConfirmedBy")
  auditLogs               AuditLog[]
  createdInternalControlRules InternalControlRule[] @relation("RuleCreatedBy")
  createdAuditFindings    AuditFinding[]        @relation("AuditFindingCreatedBy")
  assignedAuditFindings   AuditFinding[]        @relation("AuditFindingAssignee")
  approvalApplications    ApprovalApplication[] @relation("ApplicationApplicant")
  approvalAssignments     ApprovalAssignment[]
  votingsCreated          Voting[]             @relation("VotingCreatedBy")
  records                Record[]              @relation("RecordCreatedBy")
}

model InviteCode {
  id             Int       @id @default(autoincrement())
  groupId        Int
  group          Group     @relation(fields: [groupId], references: [id])
  code           String    @unique
  role           String
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  usedAt         DateTime?
  usedByMemberId Int?
  usedByMember   Member?   @relation("InviteCodeUsedBy", fields: [usedByMemberId], references: [id])
}

model Ledger {
  id                  Int           @id @default(autoincrement())
  groupId             Int
  group               Group         @relation(fields: [groupId], references: [id])
  createdByMemberId   Int
  createdBy           Member        @relation("LedgerCreatedBy", fields: [createdByMemberId], references: [id])
  title               String
  amount              Int
  transactionDate     DateTime      @default(now())
  receiptUrl          String?
  notes               String?
  status              LedgerStatus  @default(PENDING)
  approvals           Approval[]
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  sourceChatMessageId Int?          @unique
  sourceThreadId      Int?
  sourceChatMessage   ChatMessage?  @relation("LedgerSourceChat", fields: [sourceChatMessageId], references: [id])
  sourceThread        ChatThread?   @relation("LedgerThread", fields: [sourceThreadId], references: [id])
  accountId           Int?
  account             Account?      @relation("AccountLedgers", fields: [accountId], references: [id])
  eventBudgetId       Int?
  eventBudget         EventBudget?  @relation("LedgerEventBudget", fields: [eventBudgetId], references: [id])

  @@index([sourceThreadId])
  @@index([eventBudgetId])
}

model Approval {
  id               Int            @id @default(autoincrement())
  ledgerId         Int
  ledger           Ledger         @relation(fields: [ledgerId], references: [id])
  actedByMemberId  Int
  actedBy          Member         @relation("ApprovalActor", fields: [actedByMemberId], references: [id])
  action           ApprovalAction
  comment          String?
  createdAt        DateTime       @default(now())
}

model Event {
  id          Int           @id @default(autoincrement())
  groupId     Int
  group       Group         @relation(fields: [groupId], references: [id])
  title       String
  description String?
  location    String?
  startsAt    DateTime
  endsAt      DateTime?
  attendances Attendance[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  documents   Document[]
  budget      EventBudget?
  records     Record[]
}

model Attendance {
  id          Int              @id @default(autoincrement())
  eventId     Int
  event       Event            @relation(fields: [eventId], references: [id])
  memberId    Int
  member      Member           @relation(fields: [memberId], references: [id])
  status      AttendanceStatus @default(MAYBE)
  comment     String?
  respondedAt DateTime         @default(now())
  createdAt   DateTime         @default(now())

  @@unique([eventId, memberId])
}

enum LedgerStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum ApprovalAction {
  APPROVED
  REJECTED
}

enum AttendanceStatus {
  YES
  NO
  MAYBE
}

enum AuditActionType {
  CREATE
  UPDATE
  DELETE
  APPROVE
  REJECT
  CONFIRM
  IMPORT
  OTHER
}

enum AuditTargetType {
  LEDGER
  EVENT
  TODO
  DOCUMENT
  MEMBER
  SETTING
  AUDIT_FINDING
  FISCAL_YEAR_CLOSE
  EVENT_BUDGET
  EVENT_TRANSACTION
  EVENT_BUDGET_IMPORT
  APPROVAL
  ACCOUNT
}

enum InternalControlRuleType {
  SEGREGATION_OF_DUTIES
  MULTI_APPROVAL_FOR_AMOUNT
  NO_APPROVAL_NO_CONFIRM
  BUDGET_OVERAGE_ALERT
  MISSING_SOURCE_LINK
}

enum InternalControlSeverity {
  INFO
  WARN
  CRITICAL
}

enum AuditFindingCategory {
  FINANCIAL
  INTERNAL_CONTROL
}

enum AuditFindingSeverity {
  INFO
  WARN
  CRITICAL
}

enum AuditFindingStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

model AuditLog {
  id                 Int              @id @default(autoincrement())
  groupId            Int
  group              Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  actorMemberId      Int?
  actor              Member?          @relation(fields: [actorMemberId], references: [id])
  actionType         AuditActionType
  targetType         AuditTargetType
  targetId           Int?
  beforeJson         Json?
  afterJson          Json?
  sourceThreadId     Int?
  sourceThread       ChatThread?      @relation("AuditLogThread", fields: [sourceThreadId], references: [id])
  sourceChatMessageId Int?
  sourceChatMessage  ChatMessage?     @relation("AuditLogMessage", fields: [sourceChatMessageId], references: [id])
  ipAddress          String?
  userAgent          String?
  createdAt          DateTime         @default(now())

  @@index([groupId, createdAt])
  @@index([groupId, targetType, targetId])
  @@index([groupId, actorMemberId, createdAt])
}

model InternalControlRule {
  id               Int                        @id @default(autoincrement())
  groupId          Int
  group            Group                      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdByMemberId Int?
  createdBy        Member?                    @relation("RuleCreatedBy", fields: [createdByMemberId], references: [id])
  name             String
  description      String?
  ruleType         InternalControlRuleType
  conditionJson    Json
  severity         InternalControlSeverity    @default(INFO)
  isActive         Boolean                    @default(true)
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt

  @@index([groupId, isActive])
}

model AuditFinding {
  id                Int                   @id @default(autoincrement())
  groupId           Int
  group             Group                 @relation(fields: [groupId], references: [id], onDelete: Cascade)
  title             String
  description       String
  category          AuditFindingCategory
  severity          AuditFindingSeverity
  status            AuditFindingStatus     @default(OPEN)
  logIds            Int[]                  @default([])
  targetRefs        Json?
  assigneeMemberId  Int?
  assignee          Member?                @relation("AuditFindingAssignee", fields: [assigneeMemberId], references: [id])
  createdByMemberId Int
  createdBy         Member                 @relation("AuditFindingCreatedBy", fields: [createdByMemberId], references: [id])
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  @@index([groupId, status])
  @@index([groupId, severity])
}
model PersonalEvent {
  id          Int      @id @default(autoincrement())
  memberId    Int
  member      Member   @relation(fields: [memberId], references: [id])
  title       String
  description String?
  location    String?
  startsAt    DateTime
  endsAt      DateTime?
  color       String   @default("sky")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AccountingSetting {
  id                   Int      @id @default(autoincrement())
  groupId              Int      @unique
  group                Group    @relation(fields: [groupId], references: [id])
  fiscalYearStartMonth Int
  fiscalYearEndMonth   Int
  approvalFlow         String?
  carryoverAmount      Int      @default(0)
  budgetEnabled        Boolean  @default(true)
  accountingEnabled    Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model Document {
  id                  Int              @id @default(autoincrement())
  groupId             Int
  group               Group            @relation(fields: [groupId], references: [id])
  title               String
  category            DocumentCategory
  fiscalYear          Int
  eventId             Int?
  event               Event?           @relation(fields: [eventId], references: [id])
  createdByMemberId   Int
  createdBy           Member           @relation(fields: [createdByMemberId], references: [id])
  versions            DocumentVersion[]
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  sourceChatMessageId Int?             @unique
  sourceThreadId      Int?
  sourceChatMessage   ChatMessage?     @relation("DocumentSourceChat", fields: [sourceChatMessageId], references: [id])
  sourceThread        ChatThread?      @relation("DocumentThread", fields: [sourceThreadId], references: [id])

  @@index([sourceThreadId])
}

model DocumentVersion {
  id                Int      @id @default(autoincrement())
  documentId        Int
  document          Document @relation(fields: [documentId], references: [id])
  versionNumber     Int
  originalFilename  String
  storedPath        String
  mimeType          String
  sizeBytes         Int
  createdByMemberId Int
  createdBy         Member   @relation(fields: [createdByMemberId], references: [id])
  createdAt         DateTime @default(now())
}

enum DocumentCategory {
  POLICY
  REPORT
  FINANCE
  MEETING_NOTE
  OTHER
}

enum RecordSourceType {
  CHAT
  TODO
  EVENT
}

model Record {
  id                Int              @id @default(autoincrement())
  groupId           Int
  group             Group            @relation(fields: [groupId], references: [id])
  eventId           Int?
  event             Event?           @relation(fields: [eventId], references: [id])
  sourceType        RecordSourceType
  sourceId          Int?
  caption           String?          @db.VarChar(255)
  recordDate        DateTime
  fiscalYear        Int
  createdByMemberId Int
  createdBy         Member           @relation("RecordCreatedBy", fields: [createdByMemberId], references: [id])
  createdAt         DateTime         @default(now())
  photos            RecordPhoto[]

  @@index([groupId, fiscalYear])
  @@index([eventId])
}

model RecordPhoto {
  id        Int      @id @default(autoincrement())
  recordId  Int
  record    Record   @relation(fields: [recordId], references: [id])
  fileName  String
  mimeType  String
  sizeBytes Int
  url       String
  createdAt DateTime @default(now())

  @@index([recordId])
}

enum ThreadSourceType {
  TODO
  EVENT
  ACCOUNTING
  DOCUMENT
  VOTING
  FREE
}

enum ThreadStatus {
  OPEN
  CLOSED
}

enum VotingStatus {
  OPEN
  CLOSED
}

model ChatThread {
  id           Int           @id @default(autoincrement())
  groupId      Int
  group        Group         @relation(fields: [groupId], references: [id])
  title        String
  sourceType   ThreadSourceType
  sourceId     Int?
  status       ThreadStatus  @default(OPEN)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  messages     ChatMessage[]
  todoItems    TodoItem[]
  ledgerEntries Ledger[]     @relation("LedgerThread")
  documents    Document[]    @relation("DocumentThread")
  auditLogs    AuditLog[]    @relation("AuditLogThread")
  votings      Voting[]      @relation("VotingThread")
  sourceVotings Voting[]     @relation("VotingSourceThread")

  @@index([groupId, status])
  @@index([groupId, sourceType, sourceId])
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  threadId  Int
  thread    ChatThread @relation(fields: [threadId], references: [id])
  groupId   Int
  group     Group    @relation(fields: [groupId], references: [id])
  authorId  Int
  author    Member   @relation(fields: [authorId], references: [id])
  body      String
  votingId  Int?
  voting    Voting?  @relation("VotingCardMessage", fields: [votingId], references: [id])
  sourceVotings Voting[] @relation("VotingSourceMessage")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  todoItems TodoItem[]
  ledgerEntries Ledger[] @relation("LedgerSourceChat")
  documents Document[]   @relation("DocumentSourceChat")
  auditLogs AuditLog[]   @relation("AuditLogMessage")

  @@index([threadId, createdAt])
  @@index([authorId, createdAt])
}

model Voting {
  id                Int           @id @default(autoincrement())
  groupId           Int
  group             Group         @relation(fields: [groupId], references: [id])
  createdByMemberId Int
  createdBy         Member        @relation("VotingCreatedBy", fields: [createdByMemberId], references: [id])
  title             String
  description       String?
  options           Json
  deadlineAt        DateTime?
  status            VotingStatus  @default(OPEN)
  totalVotes        Int           @default(0)
  results           Json?
  threadId          Int?
  thread            ChatThread?   @relation("VotingThread", fields: [threadId], references: [id])
  sourceThreadId    Int?
  sourceThread      ChatThread?   @relation("VotingSourceThread", fields: [sourceThreadId], references: [id])
  sourceChatMessageId Int?
  sourceChatMessage ChatMessage?  @relation("VotingSourceMessage", fields: [sourceChatMessageId], references: [id])
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  votes             VotingVote[]
  comments          VotingComment[]
  todoItems         TodoItem[]    @relation("TodoFromVoting")
  cardMessages      ChatMessage[] @relation("VotingCardMessage")

  @@index([groupId, status])
}

model VotingVote {
  id        Int      @id @default(autoincrement())
  votingId  Int
  voting    Voting   @relation(fields: [votingId], references: [id])
  choiceId  String
  voteHash  String
  createdAt DateTime @default(now())

  @@unique([votingId, voteHash])
  @@index([votingId])
}

model VotingComment {
  id        Int      @id @default(autoincrement())
  votingId  Int
  voting    Voting   @relation(fields: [votingId], references: [id])
  body      String
  createdAt DateTime @default(now())

  @@index([votingId, createdAt])
}

model TodoItem {
  id                   Int        @id @default(autoincrement())
  groupId              Int
  group                Group      @relation(fields: [groupId], references: [id])
  createdByMemberId    Int
  createdBy            Member     @relation("TodoCreatedBy", fields: [createdByMemberId], references: [id])
  assignedMemberId     Int?
  assignedTo           Member?    @relation("TodoAssignedTo", fields: [assignedMemberId], references: [id])
  title                String
  body                 String?
  status               TodoStatus @default(TODO)
  dueDate              DateTime?
  sourceThreadId       Int?
  sourceVotingId       Int?
  sourceVoting         Voting?    @relation("TodoFromVoting", fields: [sourceVotingId], references: [id])
  sourceChatMessageId  Int?       @unique
  sourceChatMessage    ChatMessage? @relation(fields: [sourceChatMessageId], references: [id])
  sourceThread         ChatThread? @relation(fields: [sourceThreadId], references: [id])
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  @@index([sourceThreadId])
  @@index([sourceChatMessageId])
}

model SearchIndex {
  id         Int      @id @default(autoincrement())
  groupId    Int
  group      Group    @relation(fields: [groupId], references: [id])
  entityType String
  entityId   Int
  title      String?
  content    String?
  urlPath    String
  threadId   Int?
  eventId    Int?
  fiscalYear Int?
  occurredAt DateTime?
  searchVector Unsupported("tsvector")? @map("search_vector") @default(dbgenerated())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([entityType, entityId, groupId])
  @@index([groupId])
  @@index([entityType])
  @@index([occurredAt])
  @@index([threadId])
  @@index([eventId])
  @@index([fiscalYear])
  @@index([searchVector], type: Gin, map: "SearchIndex_search_vector_gin")
}

enum TodoStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum EventBudgetStatus {
  PLANNING
  IN_PROGRESS
  CONFIRMED
  IMPORTED
}

enum EventTransactionType {
  REVENUE
  EXPENSE
}

model Account {
  id                 Int                  @id @default(autoincrement())
  groupId            Int
  group              Group                @relation(fields: [groupId], references: [id])
  name               String
  type               AccountType
  isCustom           Boolean              @default(false)
  isArchived         Boolean              @default(false)
  order              Int                  @default(0)
  createdAt          DateTime             @default(now())
  budgets            Budget[]
  ledgers            Ledger[]             @relation("AccountLedgers")
  eventTransactions  EventTransaction[]   @relation("EventTransactionAccount")
}

model FinancialAccount {
  id             Int                  @id @default(autoincrement())
  groupId        Int
  group          Group                @relation(fields: [groupId], references: [id])
  name           String
  type           FinancialAccountType
  bankName       String?
  accountNumber  String?
  initialBalance Int                  @default(0)
  currentBalance Int                  @default(0)
  createdAt      DateTime             @default(now())
}

enum AccountType {
  ASSET
  LIABILITY
  INCOME
  EXPENSE
}

enum FinancialAccountType {
  CASH
  BANK
}

model Budget {
  id         Int      @id @default(autoincrement())
  groupId    Int
  group      Group    @relation(fields: [groupId], references: [id])
  accountId  Int
  account    Account  @relation(fields: [accountId], references: [id])
  fiscalYear Int
  amount     Int
  createdAt  DateTime @default(now())

  @@unique([groupId, accountId, fiscalYear])
}

model EventBudget {
  id                 Int                  @id @default(autoincrement())
  eventId            Int                  @unique
  event              Event                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  groupId            Int
  group              Group                @relation(fields: [groupId], references: [id], onDelete: Cascade)
  plannedRevenue     Int                  @default(0)
  plannedExpense     Int                  @default(0)
  actualRevenue      Int                  @default(0)
  actualExpense      Int                  @default(0)
  status             EventBudgetStatus    @default(PLANNING)
  confirmedAt        DateTime?
  confirmedById      Int?
  confirmedBy        Member?              @relation("EventBudgetConfirmedBy", fields: [confirmedById], references: [id])
  importedToLedgerAt DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  transactions       EventTransaction[]
  imports            EventBudgetImport[]
  ledgerEntries      Ledger[]             @relation("LedgerEventBudget")

  @@index([groupId])
  @@index([eventId])
}

model EventTransaction {
  id                Int                  @id @default(autoincrement())
  eventBudgetId     Int
  eventBudget       EventBudget          @relation(fields: [eventBudgetId], references: [id], onDelete: Cascade)
  type              EventTransactionType
  accountId         Int?
  account           Account?             @relation("EventTransactionAccount", fields: [accountId], references: [id])
  amount            Int
  description       String
  transactionDate   DateTime
  receiptUrl        String?
  notes             String?
  createdByMemberId Int
  createdBy         Member               @relation("EventTransactionCreatedBy", fields: [createdByMemberId], references: [id])
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([eventBudgetId])
  @@index([accountId])
}

model EventBudgetImport {
  id                 Int         @id @default(autoincrement())
  eventBudgetId      Int
  eventBudget        EventBudget @relation(fields: [eventBudgetId], references: [id], onDelete: Cascade)
  importedByMemberId Int
  importedBy         Member      @relation("EventBudgetImportedBy", fields: [importedByMemberId], references: [id])
  importedAt         DateTime    @default(now())
  ledgerEntryCount   Int
  notes              String?

  @@index([eventBudgetId])
}

enum FiscalYearCloseStatus {
  DRAFT
  CONFIRMED
}

model FiscalYearClose {
  id                 Int                    @id @default(autoincrement())
  groupId            Int
  group              Group                  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  fiscalYear         Int
  startDate          DateTime
  endDate            DateTime
  status             FiscalYearCloseStatus  @default(DRAFT)
  totalRevenue       Int                    @default(0)
  totalExpense       Int                    @default(0)
  balance            Int                    @default(0)
  previousCarryover  Int                    @default(0)
  nextCarryover      Int                    @default(0)
  statement          Json?
  confirmedAt        DateTime?
  confirmedById      Int?
  confirmedBy        Member?                @relation("FiscalYearCloseConfirmedBy", fields: [confirmedById], references: [id])
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  @@unique([groupId, fiscalYear])
  @@index([groupId, status])
}

enum ApprovalStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum ApprovalStepStatus {
  WAITING
  IN_PROGRESS
  APPROVED
  REJECTED
}

model ApprovalRoute {
  id        Int      @id @default(autoincrement())
  groupId   Int
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  steps     ApprovalStep[]
  templates ApprovalTemplate[]
}

model ApprovalStep {
  id           Int      @id @default(autoincrement())
  routeId      Int
  route        ApprovalRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)
  stepOrder    Int
  approverRole String
  requireAll   Boolean @default(true)
  conditions   Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  assignments  ApprovalAssignment[]
}

model ApprovalTemplate {
  id          Int      @id @default(autoincrement())
  groupId     Int
  group       Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  name        String
  description String?
  fields      Json
  routeId     Int
  route       ApprovalRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  applications ApprovalApplication[]
}

model ApprovalApplication {
  id           Int            @id @default(autoincrement())
  groupId      Int
  group        Group          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  templateId   Int
  template     ApprovalTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  applicantId  Int
  applicant    Member         @relation("ApplicationApplicant", fields: [applicantId], references: [id])
  title        String
  data         Json
  status       ApprovalStatus @default(DRAFT)
  currentStep  Int?           @default(1)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  assignments  ApprovalAssignment[]
}

model ApprovalAssignment {
  id            Int                @id @default(autoincrement())
  applicationId Int
  application   ApprovalApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  stepId        Int
  step          ApprovalStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  stepOrder     Int
  approverRole  String
  assignedToId  Int?
  assignedTo    Member?           @relation(fields: [assignedToId], references: [id])
  status        ApprovalStepStatus @default(WAITING)
  actedAt       DateTime?
  comment       String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([applicationId, stepOrder])
}
